<!DOCTYPE html>
<html>
<head>

    <title>Spring Data Cassandra: Connect To Multiple Keyspaces Via Reactive Repositories</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/fontawesome-all.css">
    <link rel="stylesheet" href="/css/syntax.css">


    <link rel="icon"
          href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMklEQVQ4jWNYem35f0owwzAygIGBAVUCCx+GSTYArxxVDUDHRMkNLi9QZMDAJ6ShawAAL/7WedGlj7QAAAAASUVORK5CYII="
          type="image/png">

    
    <meta name="article:published_time" content="2018-04-13 00:00:00 +0000">
    
    <meta name="keywords" itemprop="keywords"
          content="software, programming, blog, hleb albau, web, web3, chain, blockchain, p2p, crypto spring, spring data, repository, cassandra, apache cassandra, java, kotlin, cybersearch"/>
    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Spring Data Cassandra: Connect To Multiple Keyspaces Via Reactive Repositories | Hleb Albau</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Spring Data Cassandra: Connect To Multiple Keyspaces Via Reactive Repositories" />
<meta name="author" content="Hleb Albau" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hleb Albau Blog About Software Engineering World" />
<meta property="og:description" content="Hleb Albau Blog About Software Engineering World" />
<link rel="canonical" href="http://hleb-albau.com/spring-repositories-cassandra-multi-keyspaces" />
<meta property="og:url" content="http://hleb-albau.com/spring-repositories-cassandra-multi-keyspaces" />
<meta property="og:site_name" content="Hleb Albau" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-04-13T00:00:00+00:00" />
<meta name="google-site-verification" content="Ub8E4qroihmivg8yC8RPHxoDnJNLvKtub6rz0rFln7Q" />
<script type="application/ld+json">
{"headline":"Spring Data Cassandra: Connect To Multiple Keyspaces Via Reactive Repositories","dateModified":"2018-04-13T00:00:00+00:00","datePublished":"2018-04-13T00:00:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://hleb-albau.com/spring-repositories-cassandra-multi-keyspaces"},"url":"http://hleb-albau.com/spring-repositories-cassandra-multi-keyspaces","author":{"@type":"Person","name":"Hleb Albau"},"description":"Hleb Albau Blog About Software Engineering World","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>

<div class="content">

    <header>
        <a href="/">
            <div class="site-title">Hleb Albau</div>
        </a>
        <div class="contact-list">
            <ul>

                <li><a href="https://blockchair.com/bitcoin/address/1N55PBaxpgpq9dD93rVymigAWAwSz9iFMN"
                       title="Support me">
                    <i class="fab fa-bitcoin fa-2x"></i>
                </a></li>
                <li class="tip-button"><a href="/" onclick="return false"
                                          title="Support me using MetaMask">
                    <i class="fab fa-ethereum fa-2x"></i>
                </a></li>

                <li><a href="/feed.xml" title="Subscribe to my RSS feed">
                    <i class="fas fa-rss fa-2x"></i>
                </a></li>
                <li><a href="https://github.com/hleb-albau" title="Follow me on github">
                    <i class="fab fa-github fa-2x"></i>
                </a></li>
                <li><a href="https://hub.docker.com/u/hlebalbau/" title="Run my containers">
                    <i class="fab fa-docker fa-2x"></i>
                </a></li>
                <li><a href="https://stackoverflow.com/users/2198161/hleb-albau" title="My StackOverflow profile">
                    <i class="fab fa-stack-overflow fa-2x"></i>
                </a></li>
                <li><a href="https://twitter.com/hleb_albau" title="Tweet me">
                    <i class="fab fa-twitter fa-2x"></i>
                </a></li>
                <li><a href="https://t.me/hleb_albau" title="Chat me">
                    <i class="fab fa-telegram-plane fa-2x"></i>
                </a></li>
                <li><a href="mailto:hleb.albau@gmail.com" title="Email me">
                    <i class="fas fa-envelope fa-2x"></i>
                </a></li>

            </ul>
        </div>
    </header>

    <div class="post-title">
    <div class="title">
        <h1>Spring Data Cassandra: Connect To Multiple Keyspaces Via Reactive Repositories</h1>
        
        <span>
            <time datetime="">
                   April 13, 2018
            </time>
        </span>
        
    </div>
</div>


<p>Recently, <strong>Spring 5.0</strong> and <strong>Spring Boot 2.0</strong> were released. My team heavily using both for a while. I personally love <strong>Spring</strong>
 ecosystem moving to reactive paradigm, beside <strong>Kotlin</strong> support.</p>

<p>For some services we run <strong>Apache Cassandra</strong>  as backing storage. Initially, we use raw <a href="">Datastax Java driver</a> to communicate with db. 
 Its a solid driver with non-blocking api exposed through Guavaâ€™s <code class="highlighter-rouge">ListenableFuture</code>. Despite driver is cool, it provides too low level 
 interfaces. At some point, we found us writing similar to <strong>Spring Data Repository</strong> wrappers around default api. So, we decided 
 not to reinvent wheels and try <strong>Spring Data Cassandra</strong>.</p>

<p>The first issue we faced using that library was about connecting to multiple keyspaces within single repositories 
 context. Lack of official documentation on this theme forced us to read source code and found out solution. To 
 demonstrate it, lets start by defining our cql model(I will skip entities details).</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">bitcoin</span><span class="p">.</span><span class="n">block</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">bitcoin</span><span class="p">.</span><span class="n">tx</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">ethereum</span><span class="p">.</span><span class="n">block</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">ethereum</span><span class="p">.</span><span class="n">tx</span>
</code></pre></div></div>

<p>Than, we process by creating entities. One important note here: we should use <strong>separate</strong> packages for 
 keyspaces we want to use in one context.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">cybersearch.cassandra.bitcoin.model</span>

<span class="k">import</span> <span class="nn">org.springframework.data.cassandra.core.mapping.Table</span>

<span class="nd">@Table</span><span class="p">(</span><span class="s">"block"</span><span class="p">)</span> <span class="kd">data class</span> <span class="nc">CqlBitcoinBlock</span>
<span class="nd">@Table</span><span class="p">(</span><span class="s">"tx"</span><span class="p">)</span> <span class="kd">data class</span> <span class="nc">CqlBitcoinTx</span>
</code></pre></div></div>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">cybersearch.cassandra.ethereum.model</span>

<span class="k">import</span> <span class="nn">org.springframework.data.cassandra.core.mapping.Table</span>

<span class="nd">@Table</span><span class="p">(</span><span class="s">"block"</span><span class="p">)</span> <span class="kd">data class</span> <span class="nc">CqlEthereumBlock</span>
<span class="nd">@Table</span><span class="p">(</span><span class="s">"tx"</span><span class="p">)</span> <span class="kd">data class</span> <span class="nc">CqlEthereumTx</span>
</code></pre></div></div>

<p>So, at this point we have entities definitions. Move on and create spring reactive repositories.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">cybersearch.cassandra.bitcoin.repository</span>

<span class="kd">interface</span> <span class="nc">BitcoinBlockRepository</span> <span class="p">:</span> <span class="n">ReactiveCassandraRepository</span><span class="p">&lt;</span><span class="n">CqlBitcoinBlock</span><span class="p">,</span> <span class="n">String</span><span class="p">&gt;</span>
<span class="kd">interface</span> <span class="nc">BitcoinTxRepository</span> <span class="p">:</span> <span class="n">ReactiveCassandraRepository</span><span class="p">&lt;</span><span class="n">CqlBitcoinTx</span><span class="p">,</span> <span class="n">String</span><span class="p">&gt;</span>
</code></pre></div></div>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">cybersearch.cassandra.ethereum.repository</span>

<span class="kd">interface</span> <span class="nc">EthereumBlockRepository</span> <span class="p">:</span> <span class="n">ReactiveCassandraRepository</span><span class="p">&lt;</span><span class="n">CqlEthereumBlock</span><span class="p">,</span> <span class="n">String</span><span class="p">&gt;</span>
<span class="kd">interface</span> <span class="nc">EthereumTxRepository</span> <span class="p">:</span> <span class="n">ReactiveCassandraRepository</span><span class="p">&lt;</span><span class="n">CqlEthereumTx</span><span class="p">,</span> <span class="n">String</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>Here we come to the most lovely spring part: configuration part. Tons of magic, a lot of beens and everything else to work 
 our repositories. As usual we should provide Spring Data configuration by extending base configuration class:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">cybersearch.cassandra.bitcoin.configuration</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableReactiveCassandraRepositories</span><span class="p">(</span>
        <span class="n">basePackages</span> <span class="p">=</span> <span class="p">[</span><span class="s">"cybersearch.cassandra.bitcoin.repository"</span><span class="p">],</span>
        <span class="n">reactiveCassandraTemplateRef</span> <span class="p">=</span> <span class="s">"bitcoinKeyspaceCassandraTemplate"</span>
<span class="p">)</span>
<span class="kd">class</span> <span class="nc">BitcoinRepositoriesConfiguration</span> <span class="p">:</span> <span class="n">AbstractReactiveCassandraConfiguration</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getKeyspaceName</span><span class="p">():</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"bitcoin"</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getEntityBasePackages</span><span class="p">():</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">arrayOf</span><span class="p">(</span><span class="s">"cybersearch.cassandra.bitcoin.model"</span><span class="p">)</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="s">"bitcoinKeyspaceCassandraTemplate"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">reactiveCassandraTemplate</span><span class="p">():</span> <span class="nc">ReactiveCassandraOperations</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ReactiveCassandraTemplate</span><span class="p">(</span>
            <span class="n">DefaultReactiveSessionFactory</span><span class="p">(</span><span class="n">reactiveSession</span><span class="p">()),</span> <span class="n">cassandraConverter</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="s">"bitcoinKeyspaceReactiveSession"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">reactiveSession</span><span class="p">():</span> <span class="nc">ReactiveSession</span> <span class="p">=</span> <span class="n">DefaultBridgedReactiveSession</span><span class="p">(</span><span class="n">session</span><span class="p">().</span><span class="n">`object`</span><span class="p">)</span>

    <span class="nd">@Bean</span><span class="p">(</span><span class="s">"bitcoinKeyspaceSession"</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">session</span><span class="p">():</span> <span class="nc">CassandraSessionFactoryBean</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">session</span> <span class="p">=</span> <span class="k">super</span><span class="p">.</span><span class="n">session</span><span class="p">()</span>
        <span class="n">session</span><span class="p">.</span><span class="n">setKeyspaceName</span><span class="p">(</span><span class="n">keyspaceName</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">session</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For Ethereum, create same logical configuration. Now, we are done. Enjoy reactive repositories!</p>

</div>

<script>
    var tipButton = document.querySelector('.tip-button');
    tipButton.addEventListener('click', function () {
        if (typeof web3 === 'undefined') {
            return alert('You need to install MetaMask to use this feature. Or just send tokens to `0xb257A9F61A52D554F00db5994E98769e4DaA7f23` using your favorite signer')
        }
        var user_address = web3.eth.accounts[0];
        if (typeof user_address === 'undefined') {
            return alert('You need to log in MetaMask to use this feature.')
        }
        web3.eth.sendTransaction({
            to: "0xb257A9F61A52D554F00db5994E98769e4DaA7f23",
            from: user_address,
            value: web3.toWei('0.00', 'ether')
        }, function (err, transactionHash) {
            if (err) return alert('Error occurs ;( Thanks for trying out!');
        })
    })
</script>
</body>
</html>
